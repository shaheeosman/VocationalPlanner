import React, { useState, useRef } from 'react';
import { BookOpen, Target, List, Activity, Settings, Users, ClipboardCheck, Printer, Save, RefreshCw, ChevronDown, ChevronUp, MapPin, User, ShieldAlert, Loader2, Sparkles, Download } from 'lucide-react';

const VocationalPlanner = () => {
  const [step, setStep] = useState(0); // 0: Input Title, 1: Edit Plan, 2: Preview
  const [skillTitle, setSkillTitle] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [isDownloading, setIsDownloading] = useState(false);
  const [error, setError] = useState('');
  
  // Reference for the printable content
  const contentRef = useRef(null);
  
  // API Key - Injected by environment
  const apiKey = "";

  // Initial Empty State
  const initialPlan = {
    title: '',
    duration: '45 دقيقة',
    level: 'مبتدئ',
    location: 'ورشة عمل',
    trainingType: 'فردي',
    smartGoal: {
      action: '',
      tools: '',
      criteria: ''
    },
    taskAnalysis: ['', '', '', '', ''],
    activities: {
      sensory: '',
      kinetic: ''
    },
    accommodations: {
      environment: '',
      instruction: '',
      toolSupport: ''
    },
    scenario: {
      iDo: '',
      weDo: '',
      youDo: ''
    },
    assessment: {
      successCriteria: '',
      supervisorNote: ''
    }
  };

  const [plan, setPlan] = useState(initialPlan);
  const [activeSection, setActiveSection] = useState(null);

  // --- PDF Download Logic ---
  const handleDownloadPDF = () => {
    setIsDownloading(true);
    const element = document.getElementById('printable-content');
    
    // Options for PDF generation
    const opt = {
      margin:       [10, 10, 10, 10],
      filename:     `${plan.title.replace(/\s+/g, '_')}_خطة_عمل.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true, logging: false },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    // Dynamic script loader for html2pdf
    const generate = () => {
      if (window.html2pdf) {
        window.html2pdf().set(opt).from(element).save().then(() => {
          setIsDownloading(false);
        }).catch(err => {
          console.error(err);
          setIsDownloading(false);
          alert('حدث خطأ أثناء تحميل الملف.');
        });
      }
    };

    if (!window.html2pdf) {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      script.onload = generate;
      document.body.appendChild(script);
    } else {
      generate();
    }
  };

  // --- Gemini API Logic ---
  const generatePlanWithAI = async () => {
    if (!skillTitle.trim()) return;
    
    setIsGenerating(true);
    setError('');

    const systemPrompt = `
      You are an expert vocational rehabilitation specialist for People of Determination. 
      Your task is to generate a comprehensive, performance-based lesson plan in ARABIC based on the skill title provided by the user.
      
      Output MUST be valid JSON matching this structure exactly:
      {
        "title": "The Skill Title in Arabic",
        "duration": "Estimated time (e.g., 45 دقيقة)",
        "level": "مبتدئ or متوسط or متقدم",
        "location": "قاعة دراسية or ورشة عمل or موقع ميداني",
        "trainingType": "فردي or جماعي",
        "smartGoal": {
          "action": "Precise action verb (e.g., يفرز، يركب)",
          "tools": "Tools used",
          "criteria": "Success criteria (e.g., بنسبة دقة 100%)"
        },
        "taskAnalysis": ["Step 1", "Step 2", "Step 3", "Step 4", "Step 5"],
        "activities": {
          "sensory": "A sensory/visual activity description",
          "kinetic": "A kinetic/hands-on activity description"
        },
        "accommodations": {
          "environment": "Environment/Safety adaptations",
          "instruction": "Instructional modifications",
          "toolSupport": "Assistive tools or prompts"
        },
        "scenario": {
          "iDo": "Modeling phase description",
          "weDo": "Guided practice description",
          "youDo": "Independent practice description"
        },
        "assessment": {
          "successCriteria": "Mastery criteria",
          "supervisorNote": "Field recommendation"
        }
      }
      
      Ensure the tone is professional, encouraging, and focused on safety and independence.
    `;

    const userPrompt = `Create a vocational training plan for the skill: "${skillTitle}"`;

    try {
      const fetchWithRetry = async (retries = 3, delay = 1000) => {
        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json" }
              }),
            }
          );

          if (!response.ok) throw new Error('API Request Failed');
          return await response.json();
        } catch (err) {
          if (retries === 0) throw err;
          await new Promise(res => setTimeout(res, delay));
          return fetchWithRetry(retries - 1, delay * 2);
        }
      };

      const data = await fetchWithRetry();
      const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (generatedText) {
        const parsedPlan = JSON.parse(generatedText);
        setPlan({ ...initialPlan, ...parsedPlan });
        setStep(1);
      } else {
        throw new Error('No content generated');
      }

    } catch (err) {
      console.error("Generation Error:", err);
      setError('حدث خطأ أثناء التوليد. يرجى المحاولة مرة أخرى أو التحقق من الاتصال.');
    } finally {
      setIsGenerating(false);
    }
  };

  const handleStart = () => {
    if (skillTitle.trim()) {
       generatePlanWithAI();
    }
  };

  const loadDemoData = () => {
    setSkillTitle('مسح الرمز الشريطي (Barcode) للمنتجات');
    setPlan({
      title: 'مسح الرمز الشريطي (Barcode) للمنتجات',
      duration: '30 دقيقة',
      level: 'متوسط',
      location: 'محاكاة سوبرماركت',
      trainingType: 'فردي',
      smartGoal: {
        action: 'يمسح الرمز الشريطي للمنتج',
        tools: 'جهاز المسح (Scanner)',
        criteria: 'بنسبة دقة 100% لـ 5 منتجات متتالية'
      },
      taskAnalysis: [
        'الإمساك بالمنتج باليد اليسرى.',
        'البحث عن مكان الرمز الشريطي (الباركود).',
        'توجيه الرمز الشريطي نحو الضوء الأحمر للجهاز.',
        'الانتظار حتى سماع صوت "الرنين" (Beep).',
        'وضع المنتج في السلة المخصصة للمنتجات الممسوحة.'
      ],
      activities: {
        sensory: 'لعبة "صائد الرموز": البحث عن ملصقات الباركود المخبأة على أشكال هندسية مختلفة وتمييزها بصرياً.',
        kinetic: 'محاكاة الحركة باستخدام مكعبات خشبية ومصباح يدوي (بدلاً من السكانر) للتدرب على الزاوية الصحيحة والمسافة.'
      },
      accommodations: {
        environment: 'تثبيت جهاز المسح على الطاولة (Hands-free)، التأكد من خلو الأرضية من الأسلاك (سلامة).',
        instruction: 'وضع ملصق سهم ملون على جهاز المسح يشير إلى مكان خروج الليزر.',
        toolSupport: 'استخدام منتجات ذات رموز شريطية كبيرة الحجم في البداية.'
      },
      scenario: {
        iDo: 'يقوم المدرب بمسح منتج ببطء شديد، مشيراً بإصبعه إلى كيفية محاذاة الخط الأحمر مع الباركود، ثم يبتسم عند سماع الصوت.',
        weDo: 'يمسك المدرب يد الطالب ويوجهها نحو الباركود، ويساعده في ضبط المسافة حتى يصدر الجهاز صوتاً.',
        youDo: 'يطلب من الطالب مسح 3 منتجات مختلفة الأحجام بمفرده دون تدخل، مع تقديم تعزيز لفظي عند النجاح.'
      },
      assessment: {
        successCriteria: '3 محاولات صحيحة متتالية دون مساعدة جسدية.',
        supervisorNote: 'مراقبة سرعة الأداء وعدم تكرار مسح السلعة الواحدة مرتين.'
      }
    });
    setStep(1);
  };

  const handleInputChange = (section, field, value) => {
    if (section === 'root') {
      setPlan(prev => ({ ...prev, [field]: value }));
    } else {
      setPlan(prev => ({
        ...prev,
        [section]: {
          ...prev[section],
          [field]: value
        }
      }));
    }
  };

  const handleTaskChange = (index, value) => {
    const newTasks = [...plan.taskAnalysis];
    newTasks[index] = value;
    setPlan(prev => ({ ...prev, taskAnalysis: newTasks }));
  };

  const toggleSection = (section) => {
    setActiveSection(activeSection === section ? null : section);
  };

  const renderSectionHeader = (title, Icon, id) => (
    <button
      onClick={() => toggleSection(id)}
      className={`w-full flex items-center justify-between p-4 rounded-t-lg transition-colors ${
        activeSection === id ? 'bg-emerald-600 text-white' : 'bg-white hover:bg-emerald-50 text-gray-700 border border-gray-200'
      }`}
    >
      <div className="flex items-center gap-3">
        <Icon size={20} />
        <span className="font-bold text-lg">{title}</span>
      </div>
      {activeSection === id ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
    </button>
  );

  const renderStartView = () => (
    <div className="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-8 animate-fadeIn">
      <div className="bg-emerald-100 p-6 rounded-full text-emerald-600 mb-4 animate-bounce">
        <BookOpen size={64} />
      </div>
      <h1 className="text-4xl font-bold text-gray-800 mb-2">مخطط التأهيل المهني الذكي</h1>
      <p className="text-xl text-gray-600 max-w-2xl">
        أداة مدعومة بالذكاء الاصطناعي لتصميم خطط دروس قائمة على الأداء لأصحاب الهمم.
      </p>
      
      <div className="w-full max-w-md space-y-4">
        <input
          type="text"
          placeholder="أدخل عنوان المهارة (مثال: زراعة شتلة، تغليف هدايا)"
          className="w-full p-4 text-lg border-2 border-emerald-200 rounded-xl focus:border-emerald-500 focus:outline-none text-right shadow-sm"
          value={skillTitle}
          onChange={(e) => setSkillTitle(e.target.value)}
          disabled={isGenerating}
          dir="rtl"
        />
        
        {error && (
          <div className="text-red-500 text-sm bg-red-50 p-2 rounded text-right">
            {error}
          </div>
        )}

        <button
          onClick={handleStart}
          disabled={!skillTitle || isGenerating}
          className="w-full bg-emerald-600 hover:bg-emerald-700 disabled:bg-emerald-400 text-white font-bold py-4 px-8 rounded-xl disabled:cursor-not-allowed transition-all shadow-lg flex items-center justify-center gap-2"
        >
          {isGenerating ? (
            <>
              <Loader2 size={24} className="animate-spin" />
              جاري تحليل المهارة وتوليد الخطة...
            </>
          ) : (
            <>
              <Sparkles size={24} />
              توليد الخطة بالذكاء الاصطناعي
            </>
          )}
        </button>
        
        <div className="relative flex py-2 items-center">
          <div className="flex-grow border-t border-gray-300"></div>
          <span className="flex-shrink mx-4 text-gray-400">أو</span>
          <div className="flex-grow border-t border-gray-300"></div>
        </div>

        <button
          onClick={loadDemoData}
          disabled={isGenerating}
          className="w-full bg-white border-2 border-gray-200 hover:border-emerald-300 text-gray-600 font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-2"
        >
          <RefreshCw size={20} />
          تحميل نموذج جاهز (تجربة)
        </button>
      </div>
    </div>
  );

  const renderEditorView = () => (
    <div className="max-w-4xl mx-auto pb-20 animate-slideUp">
      <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <h2 className="text-2xl font-bold text-emerald-800 text-center md:text-right flex-1">
          إعداد الخطة: <bdi>{plan.title}</bdi>
        </h2>
        <div className="flex gap-3">
          <button onClick={() => setStep(0)} className="text-gray-500 hover:text-red-500 font-medium px-4 py-2 bg-white rounded-lg border border-gray-200">
            إنشاء خطة جديدة
          </button>
          <button 
            onClick={() => setStep(2)} 
            className="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 flex items-center gap-2 shadow-md"
          >
            <Printer size={20} />
            معاينة وتحميل PDF
          </button>
        </div>
      </div>

      <div className="space-y-4" dir="rtl">
        {/* 1. Basic Info */}
        <div className="bg-white rounded-lg shadow-sm">
          {renderSectionHeader("1. بطاقة الدرس الأساسية", ClipboardCheck, "basics")}
          {activeSection === 'basics' && (
            <div className="p-6 border-x border-b border-gray-200 rounded-b-lg space-y-4 bg-gray-50">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">الزمن المقدر</label>
                  <input
                    type="text"
                    value={plan.duration}
                    onChange={(e) => handleInputChange('root', 'duration', e.target.value)}
                    className="w-full p-3 border rounded-lg"
                    placeholder="مثال: 45 دقيقة"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">المستوى</label>
                  <select
                    value={plan.level}
                    onChange={(e) => handleInputChange('root', 'level', e.target.value)}
                    className="w-full p-3 border rounded-lg"
                  >
                    <option>مبتدئ</option>
                    <option>متوسط</option>
                    <option>متقدم</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">مكان التدريب</label>
                  <select
                    value={plan.location}
                    onChange={(e) => handleInputChange('root', 'location', e.target.value)}
                    className="w-full p-3 border rounded-lg"
                  >
                    <option>قاعة دراسية</option>
                    <option>ورشة عمل</option>
                    <option>موقع ميداني</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">نوع التدريب</label>
                  <select
                    value={plan.trainingType}
                    onChange={(e) => handleInputChange('root', 'trainingType', e.target.value)}
                    className="w-full p-3 border rounded-lg"
                  >
                    <option>فردي</option>
                    <option>جماعي</option>
                  </select>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* 2. SMART Goal */}
        <div className="bg-white rounded-lg shadow-sm">
          {renderSectionHeader("2. الهدف السلوكي (SMART)", Target, "goal")}
          {activeSection === 'goal' && (
            <div className="p-6 border-x border-b border-gray-200 rounded-b-lg space-y-4 bg-gray-50">
              <div className="p-4 bg-emerald-50 rounded-lg text-emerald-800 text-sm mb-4">
                الصيغة: بنهاية الدرس، سيقوم المتدرب بـ [الفعل] باستخدام [الأدوات] وبمعيار [الدقة].
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">الفعل الأدائي الحركي</label>
                <input
                  type="text"
                  value={plan.smartGoal.action}
                  onChange={(e) => handleInputChange('smartGoal', 'action', e.target.value)}
                  className="w-full p-3 border rounded-lg"
                  placeholder="مثال: يفرز الملابس الملونة"
                />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">الأدوات المستخدمة</label>
                  <input
                    type="text"
                    value={plan.smartGoal.tools}
                    onChange={(e) => handleInputChange('smartGoal', 'tools', e.target.value)}
                    className="w-full p-3 border rounded-lg"
                    placeholder="مثال: سلات الغسيل الملونة"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">معيار الدقة/الاستقلالية</label>
                  <input
                    type="text"
                    value={plan.smartGoal.criteria}
                    onChange={(e) => handleInputChange('smartGoal', 'criteria', e.target.value)}
                    className="w-full p-3 border rounded-lg"
                    placeholder="مثال: بنسبة خطأ 0%"
                  />
                </div>
              </div>
            </div>
          )}
        </div>

        {/* 3. Task Analysis */}
        <div className="bg-white rounded-lg shadow-sm">
          {renderSectionHeader("3. تحليل المهارة (خطوات مجهرية)", List, "tasks")}
          {activeSection === 'tasks' && (
            <div className="p-6 border-x border-b border-gray-200 rounded-b-lg space-y-3 bg-gray-50">
              {plan.taskAnalysis.map((task, index) => (
                <div key={index} className="flex gap-2 items-center">
                  <span className="bg-emerald-200 text-emerald-800 w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm">
                    {index + 1}
                  </span>
                  <input
                    type="text"
                    value={task}
                    onChange={(e) => handleTaskChange(index, e.target.value)}
                    className="w-full p-3 border rounded-lg"
                    placeholder={`الخطوة رقم ${index + 1}`}
                  />
                </div>
              ))}
              <p className="text-xs text-gray-500 mt-2">* ركز على تقسيم المهارة لأبسط أجزاء ممكنة.</p>
            </div>
          )}
        </div>

        {/* 4. Activities */}
        <div className="bg-white rounded-lg shadow-sm">
          {renderSectionHeader("4. الأنشطة التعليمية المقترحة", Activity, "activities")}
          {activeSection === 'activities' && (
            <div className="p-6 border-x border-b border-gray-200 rounded-b-lg space-y-4 bg-gray-50">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">النشاط الأول (حسي/بصري)</label>
                <textarea
                  rows="3"
                  value={plan.activities.sensory}
                  onChange={(e) => handleInputChange('activities', 'sensory', e.target.value)}
                  className="w-full p-3 border rounded-lg"
                  placeholder="مثال: مطابقة صور الأدوات مع الأدوات الحقيقية"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">النشاط الثاني (حركي/تطبيقي/لعب)</label>
                <textarea
                  rows="3"
                  value={plan.activities.kinetic}
                  onChange={(e) => handleInputChange('activities', 'kinetic', e.target.value)}
                  className="w-full p-3 border rounded-lg"
                  placeholder="مثال: لعبة تجميع القطع في أسرع وقت"
                />
              </div>
            </div>
          )}
        </div>

        {/* 5. Accommodations */}
        <div className="bg-white rounded-lg shadow-sm">
          {renderSectionHeader("5. التمايز والتكييف (Accommodations)", Settings, "accommodations")}
          {activeSection === 'accommodations' && (
            <div className="p-6 border-x border-b border-gray-200 rounded-b-lg space-y-4 bg-gray-50">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-1">
                  تعديل البيئة ومتطلبات السلامة <ShieldAlert size={14} className="text-red-500" />
                </label>
                <input
                  type="text"
                  value={plan.accommodations.environment}
                  onChange={(e) => handleInputChange('accommodations', 'environment', e.target.value)}
                  className="w-full p-3 border rounded-lg"
                  placeholder="مثال: تقليل المشتتات، تثبيت الأدوات، ارتداء قفازات واقية"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">تعديل التعليمات</label>
                <input
                  type="text"
                  value={plan.accommodations.instruction}
                  onChange={(e) => handleInputChange('accommodations', 'instruction', e.target.value)}
                  className="w-full p-3 border rounded-lg"
                  placeholder="مثال: استخدام صور توضيحية بجانب التعليمات اللفظية"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">أداة مساندة مقترحة</label>
                <input
                  type="text"
                  value={plan.accommodations.toolSupport}
                  onChange={(e) => handleInputChange('accommodations', 'toolSupport', e.target.value)}
                  className="w-full p-3 border rounded-lg"
                  placeholder="مثال: مقابض سميكة لسهولة المسك"
                />
              </div>
            </div>
          )}
        </div>

        {/* 6. Scenario */}
        <div className="bg-white rounded-lg shadow-sm">
          {renderSectionHeader("6. سيناريو التدريب المتدرج", Users, "scenario")}
          {activeSection === 'scenario' && (
            <div className="p-6 border-x border-b border-gray-200 rounded-b-lg space-y-4 bg-gray-50">
              <div className="grid grid-cols-1 gap-4">
                <div className="bg-blue-50 p-4 rounded-lg">
                  <label className="block font-bold text-blue-800 mb-1">النمذجة (I Do)</label>
                  <textarea
                    rows="3"
                    value={plan.scenario.iDo}
                    onChange={(e) => handleInputChange('scenario', 'iDo', e.target.value)}
                    className="w-full p-3 border rounded-lg"
                    placeholder="كيف سيشرح المدرب المهارة؟ (صمت ثم شرح)"
                  />
                </div>
                <div className="bg-yellow-50 p-4 rounded-lg">
                  <label className="block font-bold text-yellow-800 mb-1">الممارسة الموجهة (We Do)</label>
                  <textarea
                    rows="3"
                    value={plan.scenario.weDo}
                    onChange={(e) => handleInputChange('scenario', 'weDo', e.target.value)}
                    className="w-full p-3 border rounded-lg"
                    placeholder="التوجيه الجسدي أو اللفظي الجزئي"
                  />
                </div>
                <div className="bg-green-50 p-4 rounded-lg">
                  <label className="block font-bold text-green-800 mb-1">الممارسة المستقلة (You Do)</label>
                  <textarea
                    rows="3"
                    value={plan.scenario.youDo}
                    onChange={(e) => handleInputChange('scenario', 'youDo', e.target.value)}
                    className="w-full p-3 border rounded-lg"
                    placeholder="ما المطلوب من الطالب فعله منفرداً؟"
                  />
                </div>
              </div>
            </div>
          )}
        </div>

        {/* 7. Assessment */}
        <div className="bg-white rounded-lg shadow-sm">
          {renderSectionHeader("7. التقييم والمتابعة", ClipboardCheck, "assessment")}
          {activeSection === 'assessment' && (
            <div className="p-6 border-x border-b border-gray-200 rounded-b-lg space-y-4 bg-gray-50">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">معيار النجاح للإتقان</label>
                <input
                  type="text"
                  value={plan.assessment.successCriteria}
                  onChange={(e) => handleInputChange('assessment', 'successCriteria', e.target.value)}
                  className="w-full p-3 border rounded-lg"
                  placeholder="مثال: 3 محاولات صحيحة متتالية في يومين مختلفين"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">توصية للمشرف الميداني</label>
                <textarea
                  rows="2"
                  value={plan.assessment.supervisorNote}
                  onChange={(e) => handleInputChange('assessment', 'supervisorNote', e.target.value)}
                  className="w-full p-3 border rounded-lg"
                  placeholder="على ماذا يجب التركيز في بيئة العمل الحقيقية؟"
                />
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );

  const renderPreviewView = () => (
    <div className="max-w-4xl mx-auto animate-fadeIn">
      <div className="flex justify-between items-center mb-6 no-print">
        <button 
          onClick={() => setStep(1)} 
          className="text-emerald-700 flex items-center gap-2 font-bold"
        >
          <ChevronDown className="rotate-90" />
          العودة للتحرير
        </button>
        <button 
          onClick={handleDownloadPDF} 
          disabled={isDownloading}
          className="bg-emerald-800 text-white px-6 py-2 rounded-lg hover:bg-emerald-900 flex items-center gap-2 shadow-lg disabled:bg-emerald-400 disabled:cursor-wait"
        >
          {isDownloading ? <Loader2 size={20} className="animate-spin" /> : <Download size={20} />}
          {isDownloading ? 'جاري التحميل...' : 'تحميل بصيغة PDF'}
        </button>
      </div>

      <div 
        id="printable-content"
        ref={contentRef}
        className="bg-white p-8 rounded-none md:rounded-xl shadow-lg border border-gray-200 printable-content" 
        dir="rtl"
      >
        {/* Header */}
        <div className="border-b-4 border-emerald-600 pb-4 mb-6 flex flex-wrap justify-between items-end gap-4">
          <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2" dir="auto"><bdi>{plan.title}</bdi></h1>
            <p className="text-gray-500 text-sm">التأهيل المهني - خطة درس قائمة على الأداء</p>
          </div>
          <div className="flex flex-wrap gap-4 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-100">
            <div className="flex items-center gap-1">
              <strong>الزمن:</strong> {plan.duration}
            </div>
            <div className="w-px bg-gray-300 h-4"></div>
            <div className="flex items-center gap-1">
              <strong>المستوى:</strong> {plan.level}
            </div>
            <div className="w-px bg-gray-300 h-4"></div>
            <div className="flex items-center gap-1">
              <MapPin size={14} className="text-emerald-600" /> 
              <span>{plan.location}</span>
            </div>
            <div className="w-px bg-gray-300 h-4"></div>
            <div className="flex items-center gap-1">
               <User size={14} className="text-emerald-600" />
               <span>{plan.trainingType}</span>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 gap-6">
          {/* Goal Section */}
          <div className="bg-gray-50 p-5 rounded-lg border border-gray-200">
            <h3 className="text-emerald-800 font-bold text-lg mb-2 flex items-center gap-2">
              <Target size={20} /> <bdi>الهدف السلوكي (SMART)</bdi>
            </h3>
            <p className="text-gray-800 text-lg leading-relaxed">
              "بنهاية الدرس، سيقوم المتدرب بـ <strong>{plan.smartGoal.action || '____'}</strong> باستخدام <strong>{plan.smartGoal.tools || '____'}</strong> وبمعيار <strong>{plan.smartGoal.criteria || '____'}</strong>."
            </p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Task Analysis */}
            <div className="bg-white border border-gray-200 rounded-lg p-5">
              <h3 className="text-emerald-800 font-bold text-lg mb-3 flex items-center gap-2">
                <List size={20} /> خطوات المهارة
              </h3>
              <ul className="space-y-2">
                {plan.taskAnalysis.filter(t => t).map((task, idx) => (
                  <li key={idx} className="flex gap-2 items-start text-gray-700">
                    <span className="bg-emerald-100 text-emerald-800 min-w-[24px] h-6 flex items-center justify-center rounded text-sm font-bold mt-0.5">{idx + 1}</span>
                    <span dir="auto"><bdi>{task}</bdi></span>
                  </li>
                ))}
                {plan.taskAnalysis.filter(t => t).length === 0 && <p className="text-gray-400 italic">لا توجد خطوات مدخلة</p>}
              </ul>
            </div>

            {/* Accommodations */}
            <div className="bg-white border border-gray-200 rounded-lg p-5">
              <h3 className="text-emerald-800 font-bold text-lg mb-3 flex items-center gap-2">
                <Settings size={20} /> التكييف والسلامة
              </h3>
              <ul className="space-y-3 text-gray-700">
                <li className="flex gap-2"><span className="font-semibold text-xs bg-gray-200 px-2 py-1 rounded h-fit shrink-0">بيئة/سلامة</span> <bdi>{plan.accommodations.environment || '-'}</bdi></li>
                <li className="flex gap-2"><span className="font-semibold text-xs bg-gray-200 px-2 py-1 rounded h-fit shrink-0">تعليمات</span> <bdi>{plan.accommodations.instruction || '-'}</bdi></li>
                <li className="flex gap-2"><span className="font-semibold text-xs bg-gray-200 px-2 py-1 rounded h-fit shrink-0">مساندة</span> <bdi>{plan.accommodations.toolSupport || '-'}</bdi></li>
              </ul>
            </div>
          </div>

          {/* Activities */}
          <div className="bg-white border border-gray-200 rounded-lg p-5">
            <h3 className="text-emerald-800 font-bold text-lg mb-3 flex items-center gap-2">
              <Activity size={20} /> الأنشطة المقترحة
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-purple-50 p-3 rounded border border-purple-100">
                <strong className="block text-purple-800 mb-1 text-sm">نشاط حسي/بصري:</strong>
                <p className="text-gray-700"><bdi>{plan.activities.sensory || '-'}</bdi></p>
              </div>
              <div className="bg-orange-50 p-3 rounded border border-orange-100">
                <strong className="block text-orange-800 mb-1 text-sm">نشاط حركي/لعب:</strong>
                <p className="text-gray-700"><bdi>{plan.activities.kinetic || '-'}</bdi></p>
              </div>
            </div>
          </div>

          {/* Scenario */}
          <div className="bg-white border border-gray-200 rounded-lg p-5">
             <h3 className="text-emerald-800 font-bold text-lg mb-3 flex items-center gap-2">
              <Users size={20} /> سيناريو التدريب
            </h3>
            <table className="w-full text-sm text-right">
              <tbody>
                <tr className="border-b border-gray-100">
                  <td className="py-2 font-bold text-gray-800 w-1/4"><bdi>I Do (النمذجة)</bdi></td>
                  <td className="py-2 text-gray-700"><bdi>{plan.scenario.iDo || '-'}</bdi></td>
                </tr>
                <tr className="border-b border-gray-100">
                  <td className="py-2 font-bold text-gray-800"><bdi>We Do (الموجهة)</bdi></td>
                  <td className="py-2 text-gray-700"><bdi>{plan.scenario.weDo || '-'}</bdi></td>
                </tr>
                <tr>
                  <td className="py-2 font-bold text-gray-800"><bdi>You Do (المستقلة)</bdi></td>
                  <td className="py-2 text-gray-700"><bdi>{plan.scenario.youDo || '-'}</bdi></td>
                </tr>
              </tbody>
            </table>
          </div>

          {/* Footer Assessment */}
          <div className="bg-gray-800 text-white rounded-lg p-5 flex flex-col md:flex-row gap-6">
            <div className="flex-1">
              <strong className="block text-emerald-400 mb-1 text-xs"><bdi>معيار النجاح</bdi></strong>
              <p dir="auto"><bdi>{plan.assessment.successCriteria || '-'}</bdi></p>
            </div>
            <div className="w-px bg-gray-600 hidden md:block"></div>
            <div className="flex-1">
              <strong className="block text-emerald-400 mb-1 text-xs"><bdi>توصية للمشرف</bdi></strong>
              <p dir="auto"><bdi>{plan.assessment.supervisorNote || '-'}</bdi></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800 p-4 md:p-8" dir="rtl">
      {step === 0 && renderStartView()}
      {step === 1 && renderEditorView()}
      {step === 2 && renderPreviewView()}
      
      <style>{`
        @media print {
          .no-print { display: none !important; }
          .printable-content { 
            box-shadow: none !important; 
            border: none !important; 
            width: 100% !important;
            max-width: 100% !important;
          }
          body { background: white; }
        }
      `}</style>
    </div>
  );
};

export default VocationalPlanner;
